# 企业微信通知使用指南

## 功能概述

Azure Performance Monitor 支持通过企业微信机器人发送各种通知，主要包括：
1. **测试通知**: 验证企业微信通知功能是否正常工作
2. **自定义通知**: 发送自定义的 Markdown 格式消息
3. **代码推送通知**: 集成到 CI/CD 流程，在代码推送或 Pull Request 时发送通知

## 配置步骤

### 1. 获取企业微信 Webhook URL

- 在企业微信中创建一个群聊机器人
- 复制机器人的 Webhook URL
- 示例: `https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=c473353f-846b-4c2c-bea4-ae2644e4d955`

### 2. 本地环境配置

在 `backend/.env` 文件中配置企业微信 Webhook URL：

```bash
# 企业微信通知配置
WECOM_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=c473353f-846b-4c2c-bea4-ae2644e4d955
```

### 3. GitHub 环境配置

为了在 CI/CD 流程中安全地使用企业微信 Webhook URL，需要在 GitHub 仓库中配置为 Secret：

#### 配置步骤
1. 进入你的 GitHub 仓库
2. 点击 **Settings** > **Secrets and variables** > **Actions**
3. 点击 **New repository secret**
4. 在 **Name** 字段输入: `WECOM_WEBHOOK_URL`
5. 在 **Secret** 字段输入你的 Webhook URL: `https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=c473353f-846b-4c2c-bea4-ae2644e4d955`
6. 点击 **Add secret** 保存

#### GitHub Actions 自动通知

项目已配置了 CI/CD 工作流文件 (`/.github/workflows/ci-cd.yml`)，会在以下场景自动发送企业微信通知：
- 代码推送到 `main`、`master` 或 `develop` 分支
- 新的 Pull Request 创建（目标分支为 `main` 或 `master`）

## 使用方法

### 1. 测试通知

可以通过 API 端点发送测试通知来验证配置是否正确：

```bash
curl http://localhost:3000/api/v1/wecom/test
```

### 2. 自定义通知

发送自定义的 Markdown 格式消息：

```bash
curl -X POST http://localhost:3000/api/v1/wecom/send \
  -H "Content-Type: application/json" \
  -d '{"content": "**重要通知**\n\n系统将于今晚 22:00 进行维护升级"}'
```

### 3. 代码推送通知

通过 API 端点手动触发代码推送通知：

```bash
curl -X POST http://localhost:3000/api/v1/wecom/code-push \
  -H "Content-Type: application/json" \
  -d '{"commitId": "abc1234", "author": "张三", "message": "修复了性能问题", "repoUrl": "https://github.com/your/repo"}'
```

## Git Hook 集成

你可以在本地 Git 仓库中配置 `post-commit` 或 `post-push` 钩子，自动发送代码提交通知。在项目根目录的 `.git/hooks` 文件夹中创建相应的脚本文件即可。

## 注意事项

1. **安全性**: 请不要将 Webhook URL 暴露在公开代码仓库或日志文件中
2. **格式**: 消息内容支持 Markdown 格式，可使用加粗、列表、链接等
3. **频率**: 避免频繁发送通知，防止被企业微信限制
4. **GitHub Secrets**: 在 GitHub 中一定要使用 Secrets 存储敏感信息，不要硬编码在代码中

## API 响应格式

所有企业微信通知 API 端点返回的响应格式：

```json
{
  "success": true,
  "message": "通知发送成功"
}
```

或在出错时：

```json
{
  "success": false,
  "message": "错误信息"
}
```

## 代码结构

- `src/services/WeComNotificationService.ts`: 企业微信通知服务核心代码
- `src/controllers/wecomController.ts`: API 控制器
- `src/config/env.ts`: 环境变量配置读取
- `.github/workflows/ci-cd.yml`: GitHub Actions 配置

## 故障排除

### 常见问题
1. **通知发送失败**: 检查 `WECOM_WEBHOOK_URL` 是否正确配置
2. **企业微信收不到消息**: 确认 Webhook URL 有效，且机器人未被禁用
3. **GitHub Actions 通知失败**: 检查仓库 Secrets 中 `WECOM_WEBHOOK_URL` 是否正确配置
4. **构建错误**: 查看 GitHub Actions 日志，检查 Node.js 环境或依赖安装问题

## 后续计划

- [ ] 添加更多消息模板（如警告通知、错误通知等）
- [ ] 支持图片和文件推送
- [ ] 添加定时报告功能
- [ ] 支持多种企业微信应用集成
- [ ] 添加通知订阅管理功能