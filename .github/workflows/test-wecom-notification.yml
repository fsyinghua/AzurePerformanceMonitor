name: Test WeCom Notification

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  test-notification:
    runs-on: ubuntu-latest
    env:
      WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}

    steps:
      - name: Check network connectivity
        run: |
          echo "=== Testing network connectivity ==="
          echo "Checking IP address..."
          curl -s http://httpbin.org/ip
          echo
          
          echo "Checking WeCom API endpoint accessibility..."
          curl -v -X GET "https://qyapi.weixin.qq.com"
          echo

      - name: Test WeCom webhook directly
        run: |
          echo "=== Testing WeCom webhook ==="
          echo "Webhook URL: $WECOM_WEBHOOK_URL"
          
          # ä½¿ç”¨æœ€åŸºæœ¬çš„æµ‹è¯•æ¶ˆæ¯
          TEST_MESSAGE='{"msgtype":"markdown","markdown":{"content":"ðŸ“Š **æµ‹è¯•é€šçŸ¥**\n\nè¿™æ˜¯ä¸€æ¡ä»Ž GitHub Actions å‘é€çš„æµ‹è¯•é€šçŸ¥ï¼Œç”¨äºŽéªŒè¯ä¼ä¸šå¾®ä¿¡ Webhook è¿žæŽ¥ã€‚"}}'
          
          echo "Message content: $TEST_MESSAGE"
          echo "Sending request..."
          
          # ä½¿ç”¨è¯¦ç»†æ¨¡å¼å‘é€è¯·æ±‚
          curl -v -X POST "$WECOM_WEBHOOK_URL" \
               -H "Content-Type: application/json" \
               -d "$TEST_MESSAGE" 2>&1
          
          echo "\n=== Test complete ==="